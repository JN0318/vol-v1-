import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import streamlit as st
import numpy as np

# =================================================================
# 1. ç’°å¢ƒé…ç½®èˆ‡æ•¸æ“šæº–å‚™
# =================================================================

# è¨­ç½® Streamlit é é¢æ¨™é¡Œ
st.set_page_config(layout="wide")
st.title("ğŸ æ—¥æœ¬ V1/SV.LEAGUE ç”·æ’çƒå“¡åˆ†æ (2024-25 æ¨¡æ“¬æ•¸æ“š)")
st.markdown("---")


# ----------------------------------------------------
# â­ ä¸­æ–‡å­—é«”è¨­ç½® (è§£æ±º Matplotlib äº‚ç¢¼å•é¡Œ) â­
# è¨»ï¼šåœ¨ Streamlit Cloud ä¸Šï¼Œå¦‚æœæ²’æœ‰å®‰è£ç‰¹å®šå­—é«”ï¼Œå¯èƒ½ä»æœƒé¡¯ç¤ºæ–¹å¡Šã€‚
# é€™è£¡å˜—è©¦ä½¿ç”¨è¼ƒé€šç”¨çš„å­—é«”åç¨±ã€‚
try:
    plt.rcParams['font.family'] = ['Arial Unicode MS', 'sans-serif'] 
except:
    plt.rcParams['font.sans-serif'] = ['SimHei', 'Microsoft YaHei', 'Arial'] 
    plt.rcParams['axes.unicode_minus'] = False # è§£æ±ºè² è™Ÿäº‚ç¢¼

# ----------------------------------------------------


# å‰µå»ºæ¨¡æ“¬æ•¸æ“šé›† (ä½¿ç”¨ä¸­æ–‡è®Šæ•¸åç¨±æ–¹ä¾¿ç†è§£)
data = {
    'å§“å': ['Lopez, M.', 'Muserskiy, D.', 'Nimir, A.', 'é«˜æ©‹è—', 'è¥¿ç”°æœ‰å¿—', 'è”¡æ²›å½°', 'æŸ³ç”°å°†æ´‹', 'æ°´ç”ºæ³°æœ'],
    'ä½ç½®': ['OH', 'OP', 'OP', 'OH', 'OP', 'MB', 'OH', 'OP'],
    'éšŠä¼': ['å¤§é˜ªB', 'SUNTORY', 'WDåå¤å±‹', 'SUNTORY', 'PANTHERS', 'æ—¥é‰„å ºBZ', 'æ±äº¬GB', 'WDåå¤å±‹'],
    'ç¸½å¾—åˆ†': [550, 600, 580, 450, 400, 300, 350, 420],
    'ç¸½é€²æ”»æ¬¡æ•¸': [950, 1000, 980, 750, 700, 450, 720, 780],
    'æˆåŠŸæ‰£çƒæ•¸': [500, 520, 490, 380, 350, 240, 300, 380],
    'å¤±èª¤æ‰£çƒæ•¸': [50, 60, 50, 40, 30, 20, 40, 35],
    'æ¥ç™¼çƒç¸½æ¬¡æ•¸': [450, 50, 40, 600, 30, 5, 550, 80],
    'æ¥ç™¼çƒæˆåŠŸæ¬¡æ•¸': [250, 25, 15, 300, 10, 0, 280, 40],
    'ç™¼çƒå¾—åˆ†': [30, 40, 50, 25, 35, 10, 20, 30],
    'æ””ç¶²å¾—åˆ†': [20, 40, 40, 45, 15, 50, 30, 10]
}

df = pd.DataFrame(data)

# =================================================================
# 2. æ•¸æ“šæ¸…æ´—èˆ‡æŒ‡æ¨™è¨ˆç®—
# =================================================================

# é€²æ”»æ±ºå®šç‡ (Attack Kill Percentage): æˆåŠŸæ‰£çƒæ•¸ / ç¸½é€²æ”»æ¬¡æ•¸
df['é€²æ”»æ±ºå®šç‡'] = (df['æˆåŠŸæ‰£çƒæ•¸'] / df['ç¸½é€²æ”»æ¬¡æ•¸']) * 100

# é€²æ”»æ•ˆç‡ (Attack Efficiency): (æˆåŠŸæ‰£çƒæ•¸ - å¤±èª¤æ‰£çƒæ•¸) / ç¸½é€²æ”»æ¬¡æ•¸
df['é€²æ”»æ•ˆç‡'] = ((df['æˆåŠŸæ‰£çƒæ•¸'] - df['å¤±èª¤æ‰£çƒæ•¸']) / df['ç¸½é€²æ”»æ¬¡æ•¸']) * 100

# æ¥ç™¼çƒæˆåŠŸç‡ (Reception Success Rate): æ¥ç™¼çƒæˆåŠŸæ¬¡æ•¸ / æ¥ç™¼çƒç¸½æ¬¡æ•¸
# å®¹éŒ¯è™•ç†ï¼šé¿å…é™¤ä»¥é›¶
df['æ¥ç™¼çƒæˆåŠŸç‡'] = df.apply(
    lambda row: (row['æ¥ç™¼çƒæˆåŠŸæ¬¡æ•¸'] / row['æ¥ç™¼çƒç¸½æ¬¡æ•¸']) * 100 
    if row['æ¥ç™¼çƒç¸½æ¬¡æ•¸'] > 0 else 0, 
    axis=1
)

# =================================================================
# 3. æ•¸æ“šåˆ†æèˆ‡å¯è¦–åŒ–
# =================================================================

# --- A. æ•¸æ“šç¸½è¦½ (ä»¥ Streamlit è¡¨æ ¼å‘ˆç¾) ---
st.header("1. çƒå“¡æ ¸å¿ƒæ•¸æ“šç¸½è¦½")
display_cols = [
    'å§“å', 'ä½ç½®', 'éšŠä¼', 'ç¸½å¾—åˆ†', 
    'é€²æ”»æ±ºå®šç‡', 'é€²æ”»æ•ˆç‡', 'æ¥ç™¼çƒæˆåŠŸç‡', 
    'ç™¼çƒå¾—åˆ†', 'æ””ç¶²å¾—åˆ†'
]
st.dataframe(
    df[display_cols].sort_values(by='ç¸½å¾—åˆ†', ascending=False).set_index('å§“å'),
    use_container_width=True,
    column_config={
        'é€²æ”»æ±ºå®šç‡': st.column_config.ProgressColumn("é€²æ”»æ±ºå®šç‡ (%)", format="%.1f %%", min_value=0, max_value=60),
        'é€²æ”»æ•ˆç‡': st.column_config.ProgressColumn("é€²æ”»æ•ˆç‡ (%)", format="%.1f %%", min_value=0, max_value=55),
        'æ¥ç™¼çƒæˆåŠŸç‡': st.column_config.ProgressColumn("æ¥ç™¼çƒæˆåŠŸç‡ (%)", format="%.1f %%", min_value=0, max_value=60),
    }
)


# --- B. æ•£é»åœ–åˆ†æ (æ”»æ“Š vs. æ¥ç™¼çƒæ•ˆç‡) ---
st.header("2. æ”»æ“Šèˆ‡æ¥ç™¼çƒæ•ˆç‡æ•£é»åœ–åˆ†æ (OH & OP)")
st.write("æ­¤åœ–æ¯”è¼ƒä¸»æ”»æ‰‹å’Œæ¥æ‡‰æ‰‹åœ¨é€²æ”»å’Œé˜²å®ˆæ ¸å¿ƒä»»å‹™ä¸Šçš„è¡¨ç¾ã€‚é»è¶Šå¤§ï¼Œä»£è¡¨ç¸½å¾—åˆ†è¶Šé«˜ã€‚")

# ç¯©é¸ä¸»æ”»æ‰‹ (OH) å’Œæ¥æ‡‰ (OP)
df_oh_op = df[df['ä½ç½®'].isin(['OH', 'OP'])].copy()

plt.figure(figsize=(10, 7))
sns.scatterplot(
    data=df_oh_op, 
    x='é€²æ”»æ•ˆç‡',  # ä½¿ç”¨é€²æ”»æ•ˆç‡ä½œç‚ºæ›´åš´æ ¼çš„æŒ‡æ¨™
    y='æ¥ç™¼çƒæˆåŠŸç‡', 
    hue='ä½ç½®', 
    size='ç¸½å¾—åˆ†',  
    sizes=(80, 700), 
    style='ä½ç½®',
    palette={'OH': '#1f77b4', 'OP': '#d62728'} # è—è‰²çµ¦ä¸»æ”»ï¼Œç´…è‰²çµ¦æ¥æ‡‰
)

# ç‚ºæ¯å€‹é»æ¨™è¨»çƒå“¡åç¨±
for i in range(df_oh_op.shape[0]):
    plt.text(
        df_oh_op['é€²æ”»æ•ˆç‡'].iloc[i] + 0.3, 
        df_oh_op['æ¥ç™¼çƒæˆåŠŸç‡'].iloc[i], 
        df_oh_op['å§“å'].iloc[i], 
        fontsize=9,
        weight='bold'
    )

plt.title('V1 ç”·æ’æ”»æ“Šæ•ˆç‡ vs. æ¥ç™¼çƒæˆåŠŸç‡æ•£é»åœ–')
plt.xlabel('é€²æ”»æ•ˆç‡ (%)')
plt.ylabel('æ¥ç™¼çƒæˆåŠŸç‡ (%)')
plt.grid(True, linestyle='--', alpha=0.5)
plt.legend(title='ä½ç½®', loc='lower right')

# ğŸ“¢ Streamlit è¼¸å‡ºåœ–è¡¨ A
st.pyplot(plt.gcf())


# --- C. å¾—åˆ†çµæ§‹æ¯”è¼ƒ (å †ç–ŠæŸ±ç‹€åœ–) ---
st.header("3. çƒå“¡å¾—åˆ†çµæ§‹åˆ†æ (å †ç–ŠæŸ±ç‹€åœ–)")
st.write("æ­¤åœ–å±•ç¤ºä¸åŒçƒå“¡çš„å¾—åˆ†ä¾†æºæ§‹æˆï¼šæ‰£çƒã€ç™¼çƒå’Œæ””ç¶²ã€‚")

df_score_structure = df[['å§“å', 'æˆåŠŸæ‰£çƒæ•¸', 'ç™¼çƒå¾—åˆ†', 'æ””ç¶²å¾—åˆ†']]
# æ‰£çƒå¾—åˆ† = æˆåŠŸæ‰£çƒæ•¸ (ç°¡åŒ–è™•ç†ï¼Œå› ç‚ºç¸½å¾—åˆ†å·²åŒ…å«é€™ä¸‰é …)
df_score_structure['æ‰£çƒå¾—åˆ†'] = df_score_structure['æˆåŠŸæ‰£çƒæ•¸'] 

# ç‚ºäº†ç¹ªè£½å †ç–ŠæŸ±ç‹€åœ–ï¼Œéœ€è¦å…ˆå°‡æ•¸æ“šè½‰æ›æ ¼å¼ (melt)
df_melted = df_score_structure.melt(
    id_vars='å§“å', 
    value_vars=['æ‰£çƒå¾—åˆ†', 'ç™¼çƒå¾—åˆ†', 'æ””ç¶²å¾—åˆ†'],
    var_name='å¾—åˆ†é¡å‹', 
    value_name='å¾—åˆ†æ•¸'
)

# ç¢ºä¿æ•¸æ“šæŒ‰ç¸½å¾—åˆ†é™åºæ’åˆ—
name_order = df.sort_values(by='ç¸½å¾—åˆ†', ascending=False)['å§“å'].tolist()
df_melted['å§“å'] = pd.Categorical(df_melted['å§“å'], categories=name_order, ordered=True)
df_melted = df_melted.sort_values('å§“å')


plt.figure(figsize=(12, 6))
sns.barplot(
    data=df_melted, 
    x='å§“å', 
    y='å¾—åˆ†æ•¸', 
    hue='å¾—åˆ†é¡å‹', 
    dodge=False,  # å †ç–ŠæŸ±ç‹€åœ–
    palette={'æ‰£çƒå¾—åˆ†': '#FF5733', 'ç™¼çƒå¾—åˆ†': '#33FF57', 'æ””ç¶²å¾—åˆ†': '#3357FF'}
)

plt.title('V1 ç”·æ’çƒå“¡å¾—åˆ†çµæ§‹åˆ†æ')
plt.xlabel('çƒå“¡å§“å')
plt.ylabel('å¾—åˆ†æ•¸')
plt.legend(title='å¾—åˆ†é¡å‹', loc='upper right')
plt.xticks(rotation=45, ha='right')
plt.tight_layout()

# ğŸ“¢ Streamlit è¼¸å‡ºåœ–è¡¨ B
st.pyplot(plt.gcf())

st.markdown("---")
st.caption("æ•¸æ“šä¾†æºï¼šæ¨¡æ“¬ 2024-25 è³½å­£ V1/SV.LEAGUE ç”·æ’æ•¸æ“šã€‚")

# =================================================================
# ç¨‹å¼ç¢¼çµæŸ
# =================================================================
